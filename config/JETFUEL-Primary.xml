<?xml version="1.0" encoding="UTF-8"?>
<AMPSConfig>
    <Name>JETFUEL-PRIMARY</Name>
    <Group>LONDON</Group>
    <Admin>
        <InetAddr>localhost:8199</InetAddr>
        <SQLTransport>websocket-any</SQLTransport>
    </Admin>
    <SOWStatsInterval>5s</SOWStatsInterval>
    <RequiredMinimumVersion>5.0</RequiredMinimumVersion>

    <Transports>
        <Transport>
            <Name>json-tcp</Name>
            <Type>tcp</Type>
            <InetAddr>8001</InetAddr>
            <ReuseAddr>true</ReuseAddr>
            <MessageType>json</MessageType>
            <Protocol>amps</Protocol>
        </Transport>
        <Transport>
            <Name>websocket-any</Name>
            <Protocol>websocket</Protocol>
            <Type>tcp</Type>
            <InetAddr>9008</InetAddr>
        </Transport>
    </Transports>

    <Logging>
        <Target>
            <Protocol>file</Protocol>
            <FileName>${AMPS_CONFIG_DIRECTORY}/logs/%Y%m%d-%H%M%S-%n.log</FileName>
            <RotationThreshold>200MB</RotationThreshold>
            <Level>info</Level>
        </Target>
    </Logging>

    <SOW>

        <Topic>
            <FileName>${AMPS_CONFIG_DIRECTORY}/sow/%n-json.sow</FileName>
            <Topic>JETFUEL_EXECUTE</Topic>
            <Key>/ID</Key>
            <MessageType>json</MessageType>
            <Expiration>600m</Expiration>
        </Topic>

        <Topic>
            <FileName>${AMPS_CONFIG_DIRECTORY}/sow/%n-json.sow</FileName>
            <Topic>JETFUEL_EXECUTE_BUS</Topic>
            <Key>/ID</Key>
            <MessageType>json</MessageType>
            <Expiration>25h</Expiration>
        </Topic>

        <Topic>
            <FileName>${AMPS_CONFIG_DIRECTORY}/sow/%n-json.sow</FileName>
            <Topic>TEST_PRICE</Topic>
            <Key>/ID</Key>
            <MessageType>json</MessageType>
            <Expiration>400d</Expiration>
        </Topic>
    </SOW>

    <TransactionLog>
        <JournalDirectory>${AMPS_CONFIG_DIRECTORY}/journal</JournalDirectory>
        <PreallocatedJournalFiles>1</PreallocatedJournalFiles>
        <MinJournalSize>10MB</MinJournalSize>
        <Topic>
            <Name>.*</Name>
            <MessageType>json</MessageType>
        </Topic>
        <FlushInterval>100ms</FlushInterval>
    </TransactionLog>

    <Actions>
        <Action>
            <On>
                <Module>amps-action-on-disconnect-client</Module>
            </On>
            <Do>
                <Module>amps-action-do-delete-sow</Module>
                <Options>
                    <Topic>JETFUEL_EXECUTE</Topic>
                    <Filter>/FunctionPublisherName = "{{AMPS_CLIENT_NAME}}"</Filter>
                    <MessageType>json</MessageType>
                </Options>
            </Do>
        </Action>
        <Action>
            <On>
                <Module>amps-action-on-message-condition-timeout</Module>
                <Options>
                    <MessageType>json</MessageType>
                    <Topic>JETFUEL_EXECUTE_BUS</Topic>
                    <Filter>/CurrentState = 'StateNew'</Filter>
                    <Duration>5s</Duration>
                </Options>
            </On>
            <Do>
                <Module>amps-action-do-extract-values</Module>
                <Options>
                    <MessageType>json</MessageType>
                    <Data>{{AMPS_DATA}}</Data>
                    <Value>ID_TO_USE=/ID</Value>
                </Options>
            </Do>
            <Do>
                <Module>amps-action-do-extract-values</Module>
                <Options>
                    <MessageType>json</MessageType>
                    <Data>{{AMPS_DATA}}</Data>
                    <Value>CALLER_HOSTNAME=/FunctionCallerHostName</Value>
                </Options>
            </Do>
            <Do>
                <Module>amps-action-do-extract-values</Module>
                <Options>
                    <MessageType>json</MessageType>
                    <Data>{{AMPS_DATA}}</Data>
                    <Value>CALLER=/FunctionInitiatorName</Value>
                </Options>
            </Do>
            <Do>
                <Module>amps-action-do-extract-values</Module>
                <Options>
                    <MessageType>json</MessageType>
                    <Data>{{AMPS_DATA}}</Data>
                    <Value>FORMATTED_DATE_TIME = STRFTIME("%Y-%m-%dT%H:%M:%S.%03f", UNIX_TIMESTAMP())</Value>
                </Options>
            </Do>
            <Do>
                <Module>amps-action-do-publish-message</Module>
                <Options>
                    <MessageType>json</MessageType>
                    <Topic>JETFUEL_EXECUTE_BUS</Topic>
                    <Delta>True</Delta>
                    <UpdateOnly>True</UpdateOnly>
                    <Data>{"ID":"{{ID_TO_USE}}","FunctionCallerHostName":"{{CALLER_HOSTNAME}}","FunctionInitiatorName":"{{CALLER}}","MsgCreationName":"JETFUEL-PRIMARY","MsgCreationTime":"{{FORMATTED_DATE_TIME}}","CurrentState":"StateTimeout","CurrentStateMsg":"Function publisher that published this function is not available now."}</Data>
                </Options>
            </Do>
        </Action>
        <Action>
            <On>
                <Module>amps-action-on-startup</Module>
            </On>
            <Do>
                <Module>amps-action-do-delete-sow</Module>
                <Options>
                    <MessageType>json</MessageType>
                    <Topic>JETFUEL_EXECUTE</Topic>
                    <Filter>1=1</Filter>
                </Options>
            </Do>
        </Action>
    </Actions>

</AMPSConfig>

